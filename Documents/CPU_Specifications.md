# CPU仕様書 (AI Logic Specifications)

## 概要
本ドキュメントは、`BattleManager.cs` および `CardController.cs` に実装されたCPU（敵AI）の行動ロジックと仕様をまとめたものです。
CPUは「オフライン対戦」時に動作し、プレイヤーと同様のルールでデッキを使用、マナを消費してカードをプレイします。

---

## 1. デッキ・手札管理

### デッキ構築
- `GameManager` の `IsOnlineBattle == false` の場合、CPU専用のデッキリスト (`enemyBattledeck`) をディープコピーして使用します。

### 初期手札とマリガン
1.  **初期手札**: プレイヤーと同じく3枚ドローして開始します。
2.  **マリガン (引き直し)**:
    - 手札にある **コスト4以上** のカードをすべてデッキに戻し、同数を引き直します。
    - 序盤の事故を防ぎ、低コストカードを確保する動きをします。

### 手札の可視性
- **`EnemyHandPanel`**: CPUの手札にあるカードは、専用のパネルで隠されます（裏面表示のような扱い）。
- フィールドに召喚された時点でパネルが非表示になり、カード情報が公開されます。
- プレイヤーはCPUの手札をクリックしても詳細を見ることはできません。

---

## 2. ターン進行フロー (`EnemyTurn`)

CPUのターンは以下の順序で進行します。

1.  **マナ回復**:
    - ターン開始時に最大マナ (`enemyDefaultManaPoint`) を+1し、現在マナを全回復します（最大10）。
2.  **ドロー**:
    - デッキからカードを1枚引きます。
3.  **コストリセット**:
    - 前のターンのコスト変動を元に戻します。
4.  **じゃんけんフェイズ**:
    - 出す手を決定し、プレイヤーと勝負します（後述）。
5.  **召喚フェイズ**:
    - マナが尽きるかフィールドが埋まるまで、評価値の高いカードを召喚します。
6.  **攻撃フェイズ**:
    - 盤面の状況に応じて、相手リーダーまたはユニットを攻撃します。

---

## 3. じゃんけんロジック (`GetBestCPUJankenHand`)

CPUは状況（攻撃側/防御側）に応じて異なるロジックで手を決定します。

### A. プレイヤーのターン（防御時）
**目的**: 相手の攻撃を防ぐ、または有利を取る。
1.  **予測**: プレイヤーの手札にある属性（グー・チョキ・パー）の枚数をカウントし、最も多い属性を「プレイヤーが出す手」と予測します。
    - 枚数が同数の場合はランダムに予測します。
2.  **決定**: 予測した手に **勝つ手** を選択します。
3.  **ランダム性**: 行動が読まれないよう、**30%の確率でランダムな手** を選択します。

### B. CPUのターン（攻撃時）
**目的**: 自分のコンボを通す、強力なカードを展開する。
1.  **シミュレーション**: グー・チョキ・パーそれぞれを出した場合の展開をシミュレーションします。
2.  **スコア計算**:
    - その手を出して勝った場合（または負けた場合）のコスト変動を計算。
    - その状態で「現在マナで召喚可能なカード」の **スコア合計** を算出します。
    - **じゃんけん自体の勝敗スコアは加算しません**。あくまで「強い動きができるか」を重視します。
3.  **決定**: 最もスコア合計が高い手を選択します。
    - これにより、「勝てばコストが下がって大型ユニットが出せる」ような手を積極的に選びます。

---

## 4. カード評価ロジック (`GetCardScore`)

CPUは手札のカードを以下の基準で数値化し、召喚優先度を決定します。

### 基本スコア
- **パワー**: `Power * 100`
- **コスト**: `Cost * 300` （高コストカードを高く評価し、マナが余っていれば強いカードから出すように調整）

### 常時発動効果ボーナス
- **スピードアタッカー**: `+500` （即座に攻撃可能）
- **ドロー効果**: `枚数 * 200`
- **マナブースト**: `枚数 * 300`
- **破壊効果 (単体)**: `+1000` （相手の場に対象となる属性のカードがいる場合のみ）
- **全破壊**:
    - 相手の場の数 > 自分の場の数: `+1500`
    - 自分の場の数 >= 相手の場の数: `-500` （自爆回避）

### 条件付き効果ボーナス
じゃんけんの結果や出した手によって発動する効果も加算されます。
- **勝利時/敗北時/属性一致時**:
    - スピードアタッカー付与: `+500`
    - 召喚効果: `枚数 * 300`
    - その他（パワーアップ、回復など）も係数に基づいて加算。

---

## 5. 攻撃ロジック

### A. リーサルチェック (Lethal Check)
- 攻撃可能な全ユニットの攻撃力合計を計算します。
- **合計攻撃力 >= プレイヤーのHP** の場合：
    - 相手ユニットを無視し、全ての攻撃をプレイヤーリーダーに向けます（勝利確定の動き）。

### B. スマートトレード (Smart Trading)
リーサルがない場合、有利な交換（トレード）を狙います。
1.  **ターゲット選定**:
    - 以下の条件を満たす相手ユニットを探します。
        - じゃんけんで勝利（一方的に破壊）。
        - じゃんけんであいこ かつ パワー勝ち。
2.  **優先順位**:
    - 「弱い味方」で「強い敵」を倒せる組み合わせを最優先します。
    - これにより、主力を温存しつつ相手の盤面を崩します。

### C. リーダー攻撃
- 有利なトレード対象がいない、または相手の場にユニットがいない場合は、プレイヤーリーダーを攻撃します。

---

## 6. その他仕様修正点

### 破壊効果のターゲット制限
- `destroyjan` (単体破壊) および `destroyjan2` (複数破壊) の効果処理において、**`FieldCard == true`** の条件を追加しました。
- これにより、CPUが効果を使用した際、誤って「プレイヤーの手札」を破壊してしまうバグが修正されています。
